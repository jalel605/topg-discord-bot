/**
 * ุชุทุจูู Express Node.js ูุชุชุจุน ุงูุชุตููุชุงุช ูุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช ุฅูู Discord
 * ูุนุชูุฏ ุนูู TopG.org ุจุงุณุชุฎุฏุงู ุงูู Webhook ุงูุฎุงุต ุจูุง.
 * * Dependencies:
 * - express: ูุฅูุดุงุก ุฎุงุฏู ุงูููุจ
 * - axios: ูุฅุฑุณุงู ุทูุจุงุช HTTP (ุฅูู Discord Webhook)
 * - node-cron: ูุฌุฏููุฉ ุงูููุงู ุงููุชูุฑุฑุฉ (ุงูุชูุฑูุฑ ุงููููู)
 */
const express = require('express');
const axios = require('axios');
const cron = require('node-cron');
const app = express();

// ุฅุนุฏุงุฏ Express ูุชุญููู ุงูู JSON ูุงูุจูุงูุงุช ุงูููุฑุณูุฉ ุนุจุฑ URL-encoded
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// =========================================================
//                  ุงููุชุบูุฑุงุช ุงูุฃุณุงุณูุฉ (Configuration)
// =========================================================

// ุฑุงุจุท Discord Webhook (ูุฌุจ ุชุนูููู ููุชุบูุฑ ุจูุฆุฉ)
const DISCORD_WEBHOOK_URL = process.env.DISCORD_WEBHOOK_URL;
// ุฑุงุจุท ุณูุฑูุฑู ุนูู TopGุ ููุณุชุฎุฏู ูู ุฃุฒุฑุงุฑ ุงูุชุตููุช ูุงูุชูุงุฑูุฑ
const SERVER_LINK = "https://topg.org/cs-servers/server-676666"; 

// ูุชุบูุฑ ูุญูุธ ุนุฏุฏ ุงูุฃุตูุงุช ุงูููููุฉ
let dailyVotes = 0;

// =========================================================
//                   ูุธุงุฆู Discord Webhook
// =========================================================

/**
 * ุฏุงูุฉ ูุฅุฑุณุงู ุฑุณุงูุฉ ุนูุฏ ุชุดุบูู ุงูุณูุฑูุฑ ุจูุฌุงุญ.
 */
async function sendStartupMessage() {
    if (!DISCORD_WEBHOOK_URL) {
        console.warn("โ๏ธ ุชุญุฐูุฑ: ูู ูุชู ุชุนููู ูุชุบูุฑ DISCORD_WEBHOOK_URL. ูู ูุชู ุฅุฑุณุงู ุฅุดุนุงุฑุงุช Discord.");
        return;
    }

    try {
        console.log("ุฌุงุฑู ุฅุฑุณุงู ุฑุณุงูุฉ ุจุฏุก ุงูุชุดุบูู ุฅูู Discord...");
        await axios.post(DISCORD_WEBHOOK_URL, {
            embeds: [
                {
                    title: "๐ข ุงูุฑูุจูุช ูุชุตู ูุฌุงูุฒ!",
                    description: "ูุธุงู ุชุชุจุน ุงูุชุตููุชุงุช ุนูู TopG ูุนูู ุจูุฌุงุญ.",
                    color: 5763719, // ููู ุฃุฎุถุฑ
                    fields: [
                        {
                            name: "๐ ุญุงูุฉ ุงูุณูุฑูุฑ",
                            value: "ูุณุชูุน ูุทูุจุงุช ุงูุชุตููุช...",
                            inline: true
                        },
                        {
                            name: "๐ ุฑุงุจุท ุงูุชุตููุช",
                            value: `[ุงุถุบุท ููุง ููุชุตููุช](${SERVER_LINK})`,
                            inline: true
                        },
                        {
                            name: "โน๏ธ ูุนูููุงุช",
                            value: "ููููู ุงูุชุตููุช ูู **6 ุณุงุนุงุช**.\nุณูุชู ุฅุฑุณุงู ุงูุฅุญุตุงุฆูุงุช ุงูููููุฉ ุนูุฏ ููุชุตู ุงูููู.",
                            inline: false
                        }
                    ],
                    footer: {
                        text: "ุงููุธุงู ูุฏุนูู ูู Render"
                    },
                    timestamp: new Date().toISOString() // ุงุณุชุฎุฏุงู ISOString ูุถูุงู ุงูุชูุณูู ุงูุตุญูุญ
                }
            ]
        });
        console.log("ุชู ุฅุฑุณุงู ุฑุณุงูุฉ ุจุฏุก ุงูุชุดุบูู ุจูุฌุงุญ.");
    } catch (error) {
        console.error("ุฎุทุฃ ูู ุฅุฑุณุงู ุฑุณุงูุฉ ุจุฏุก ุงูุชุดุบูู:", error.message);
    }
}

/**
 * ุฏุงูุฉ ูุฅุฑุณุงู ุชูุฑูุฑ ูููู ุจุนุฏุฏ ุงูุฃุตูุงุช.
 */
async function sendDailyReport() {
    if (!DISCORD_WEBHOOK_URL) return;

    try {
        console.log(`ุฌุงุฑู ุฅุฑุณุงู ุงูุชูุฑูุฑ ุงููููู ุจู ${dailyVotes} ุตูุช.`);
        await axios.post(DISCORD_WEBHOOK_URL, {
            embeds: [
                {
                    title: "๐ ุชูุฑูุฑ ุงูุชุตููุช ุงููููู",
                    description: `ููุฏ ุชููููุง **${dailyVotes}** ุตูุชูุง ุงูููู!`,
                    color: 15105570, // ููู ุจุฑุชูุงูู
                    fields: [
                        { name: "ุตููุช ูุฑุฉ ุฃุฎุฑู", value: `[ุงูุฑุงุจุท](${SERVER_LINK})` }
                    ],
                    timestamp: new Date().toISOString()
                }
            ]
        });
        console.log("ุชู ุฅุฑุณุงู ุงูุชูุฑูุฑ ุงููููู ุจูุฌุงุญ.");
    } catch (error) {
        console.error("ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุชูุฑูุฑ ุงููููู:", error.message);
    }
}


// =========================================================
//                         ูุณุงุฑุงุช Express
// =========================================================

// ุงููุณุงุฑ ุงูุฑุฆูุณู (Health Check)
app.get('/', (req, res) => {
    res.status(200).send(`Server is Running. Today's votes: ${dailyVotes}`);
});

/**
 * 2. ูุณุงุฑ ุงุณุชูุจุงู ุงูุชุตููุช (Webhook Endpoint)
 * ูุณุชุฎุฏู TopG ูุฅุฑุณุงู ุทูุจ GET ุนูุฏ ูู ุชุตููุช ูุงุฌุญ.
 * ูุชููุน ุฃู ูุญุชูู ุนูู query parameter ุจุงุณู 'p_resp' ูุนููุงู IP ุงููุตููุช.
 */
app.get('/vote', async (req, res) => {
    // ุงุณุชุฎุฑุงุฌ IP ุงููุตูุช ูู query parameter 'p_resp'
    const voter_ip = req.query.p_resp || "Unknown IP (No p_resp provided)";
    
    // ุฒูุงุฏุฉ ุนุฏุฏ ุงูุฃุตูุงุช ุงูููููุฉ
    dailyVotes++;
    
    console.log(`โ ุชุตููุช ุฌุฏูุฏ ูู: ${voter_ip}. ุงูุฅุฌูุงูู ุงููููู: ${dailyVotes}`);

    if (DISCORD_WEBHOOK_URL) {
        try {
            await axios.post(DISCORD_WEBHOOK_URL, {
                embeds: [
                    {
                        title: "โ ุชู ุงุณุชูุงู ุชุตููุช ุฌุฏูุฏ!",
                        description: "**ุดูุฑูุง ูู ุนูู ุฏุนูู ููุณูุฑูุฑ!**",
                        color: 3447003, // ุฃุฒุฑู
                        fields: [
                            // ูุณุชุฎุฏู || ุญูู IP ูุฅุฎูุงุฆู ูู Discord ูู spoiler
                            { name: "IP ุงููุตููุช", value: `||${voter_ip}||`, inline: true },
                            { name: "ุงูุฅุฌูุงูู ุงููููู", value: `${dailyVotes}`, inline: true }
                        ],
                        timestamp: new Date().toISOString()
                    }
                ]
            });
        } catch (error) { 
            console.error("ุฎุทุฃ ูู ุฅุฑุณุงู ุฅุดุนุงุฑ ุงูุชุตููุช:", error.message); 
        }
    }
    
    // ูุฌุจ ุฏุงุฆููุง ุฅุฑุณุงู ุงุณุชุฌุงุจุฉ ุณุฑูุนุฉ ููู Webhook
    res.status(200).send('Vote Received');
});

// =========================================================
//                         ุฌุฏููุฉ ุงูููุงู (Cron Job)
// =========================================================

/**
 * 3. ุงูุฌุฏููุฉ: ุฅุฑุณุงู ุงูุชูุฑูุฑ ุงููููู ูุชุตููุฑ ุงูุนุฏุงุฏ (ุงูุณุงุนุฉ 12:00 ุตุจุงุญูุง ุจุชูููุช UTC)
 * ุงูุตูุบุฉ: 'minute hour day_of_month month day_of_week'
 * '0 0 * * *' ุชุนูู 0 ุฏูููุฉุ 0 ุณุงุนุฉ (ููุชุตู ุงูููู) ูู ููู.
 */
cron.schedule('0 0 * * *', async () => {
    console.log("--- ุชุดุบูู ูููุฉ ุงูุชูุฑูุฑ ุงููููู ---");
    
    // ุฅุฑุณุงู ุงูุชูุฑูุฑ ุฃููุงู
    await sendDailyReport(); 
    
    // ุชุตููุฑ ุนุฏุงุฏ ุงูุฃุตูุงุช ุงูููููุฉ
    dailyVotes = 0;
    console.log("ุชู ุชุตููุฑ ุนุฏุงุฏ ุงูุฃุตูุงุช ุงูููููุฉ.");
}, {
    timezone: "UTC" // ููุถู ุชุญุฏูุฏ ุงูุชูููุช ูุถูุงู ุงูุชูุงุณู
});


// =========================================================
//                   ุจุฏุก ุชุดุบูู ุงูุณูุฑูุฑ
// =========================================================

const PORT = process.env.PORT || 3000;

app.listen(PORT, () => {
    console.log(`๐ ุงูุณูุฑูุฑ ุจุฏุฃ ุงูุนูู ุนูู ุงููููุฐ: ${PORT}`);
    
    // ูุณุชุฏุนู ุฏุงูุฉ ุฑุณุงูุฉ ุงูุชุดุบูู ุนูุฏ ุจุฏุก ุงูุณูุฑูุฑ
    sendStartupMessage();
});